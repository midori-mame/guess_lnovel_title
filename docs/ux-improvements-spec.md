# UX 개선 기능 구현 명세서

> **오늘 개발할 범위:** 모바일 스크롤/드래그 충돌 해결, 메인화면 복귀 버튼, 정보 탭, 문제 수 조정, "틀려도 괜찮아" 탭 버그 수정 및 새로고침 버튼
> 기존 게임 구현 가이드(`game-implementation-guide.md`)를 먼저 숙지한 뒤 이 문서를 읽을 것.
> 백엔드 변경 없음. 프론트엔드 전용 작업.

---

## 목차

1. [모바일 스크롤/드래그 충돌 해결](#1-모바일-스크롤드래그-충돌-해결)
2. [메인화면 복귀 버튼](#2-메인화면-복귀-버튼)
3. [정보 탭 추가](#3-정보-탭-추가)
4. [문제 수 조정 기능](#4-문제-수-조정-기능)
5. ["틀려도 괜찮아" 탭 — 모바일 가로 넘침 수정](#5-틀려도-괜찮아-탭--모바일-가로-넘침-수정)
6. ["틀려도 괜찮아" 탭 — 새로고침 버튼 추가](#6-틀려도-괜찮아-탭--새로고침-버튼-추가)
7. [구현 순서](#7-구현-순서)

---

## 1. 모바일 스크롤/드래그 충돌 해결

### 문제 상황

모바일에서 `TokenPool` 영역을 손가락으로 스크롤하려 할 때, 브라우저가 터치 이벤트를
스크롤이 아닌 드래그로 해석하여 두 동작이 충돌한다.

### 원인

`TokenPool`과 `InputArea`의 토큰 카드에 드래그 관련 이벤트 핸들러(`onMouseDown`,
`onTouchStart` 등)가 등록되어 있으면, 브라우저의 기본 스크롤 동작이 억제된다.

### 해결 방법: 탭(tap) 방식으로 통일

드래그 인터랙션을 제거하고, **단순 탭(클릭)으로만 토큰을 선택·배치**하는 방식으로
통일한다. 기존 PC 클릭 동작과 동일하게 동작하므로 별도 분기 처리가 필요 없다.

#### TokenPool 카드

- `onClick` 핸들러만 유지
- `onMouseDown`, `onTouchStart`, `draggable` 등 드래그 관련 속성 모두 제거
- 탭하면 토큰이 `InputArea` 끝에 추가되는 기존 동작 유지

#### InputArea 카드

- `onClick` 핸들러만 유지 (탭하면 `TokenPool`로 반환)
- 드래그 관련 속성 모두 제거

#### 스크롤 보장

`TokenPool` 컨테이너에 아래 CSS를 적용하여 세로 스크롤이 항상 동작하도록 보장한다.

```css
touch-action: pan-y;   /* 세로 스크롤 허용, 가로 제스처 차단 */
overflow-y: auto;
```

Tailwind 클래스로는 `touch-pan-y overflow-y-auto`를 사용한다.
`touch-pan-y`가 Tailwind 기본 클래스에 없으면 `style={{ touchAction: 'pan-y' }}`
인라인 스타일로 적용한다.

#### 검증 조건

- 모바일(또는 브라우저 DevTools 모바일 에뮬레이터)에서 `TokenPool` 영역을
  위아래로 스와이프했을 때 페이지가 스크롤되어야 한다.
- 토큰 카드를 탭했을 때 선택/취소가 정상 동작해야 한다.

---

## 2. 메인화면 복귀 버튼

### 기능 설명

게임 진행 중(`phase === "playing"`) `GameHeader`에 메인화면으로 돌아가는 버튼을 추가한다.

### UI 위치 및 디자인

- `GameHeader` 컴포넌트의 **좌측 상단**에 배치
- 기존 설정 뱃지(난이도, 채점 방식, 게임 모드) 왼쪽에 위치
- 아이콘: `←` 또는 `⌂` (홈 아이콘)
- 레이블: "처음으로"
- 스타일: 작고 눈에 띄지 않는 보조 버튼 (ghost 또는 outline 스타일)

### 동작

버튼 클릭 시 **확인 다이얼로그**를 띄운다. 게임 진행 중 실수로 누르는 경우를 방지하기 위함이다.

```
"게임을 종료하고 처음으로 돌아가시겠어요?
 현재 진행 상황은 저장되지 않습니다."

[취소]  [처음으로]
```

- **취소**: 다이얼로그 닫기, 게임 계속 진행
- **처음으로**: `phase`를 `"setup"`으로 전이, 게임 상태 초기화

### State 전이

기존 `GameState`에 별도 액션을 추가한다.

```typescript
// types/index.ts 에 추가
type GameAction =
  | ... // 기존 액션들
  | { type: "RETURN_TO_SETUP" }  // 메인화면 복귀
```

`RETURN_TO_SETUP` 리듀서 처리:

```typescript
case "RETURN_TO_SETUP":
  return {
    ...initialState,   // 모든 상태를 초기값으로 리셋
    phase: "setup",
  };
```

### 다이얼로그 구현

별도 컴포넌트(`<ConfirmDialog />`)로 분리한다. 이후 다른 확인 다이얼로그에도 재사용할 수 있도록 범용으로 만든다.

```typescript
// components/ConfirmDialog.tsx
interface ConfirmDialogProps {
  isOpen:    boolean;
  message:   string;
  onConfirm: () => void;
  onCancel:  () => void;
  confirmLabel?: string;  // 기본값: "확인"
  cancelLabel?:  string;  // 기본값: "취소"
}
```

---

## 3. 정보 탭 추가

### 기능 설명

`SetupScreen`(메인화면)에 "정보" 탭을 추가한다.
탭 내용은 사람이 직접 수정할 것이므로, 이 문서에서 지정하는 **placeholder 텍스트**만
정확하게 삽입하면 된다. 레이아웃과 스타일만 완성할 것.

### SetupScreen 탭 구조

메인화면을 탭 형식으로 변경한다.

```
[ 게임 시작 ]  [ 정보 ]
━━━━━━━━━━━━━━━━━━━━━
  (선택된 탭 내용)
```

- 기본 선택 탭: **게임 시작**
- "게임 시작" 탭: 기존 SetupScreen 내용 그대로 (게임 모드, 난이도, 채점 방식, 시작 버튼)
- "정보" 탭: 아래 placeholder 내용

### 정보 탭 Placeholder 내용

아래 텍스트를 그대로 사용한다. 마크다운 렌더링 없이 일반 텍스트/섹션으로 표시한다.

```
게임 소개
----------
[PLACEHOLDER: 게임 소개 텍스트를 여기에 작성하세요.]

수록 작품 출처
----------
[PLACEHOLDER: 수록 작품 출처 및 저작권 안내를 여기에 작성하세요.]

문의 / 피드백
----------
[PLACEHOLDER: 문의처 또는 피드백 링크를 여기에 작성하세요.]

버전
----------
v0.1.0
```

### 구현 시 주의사항

- placeholder 텍스트는 컴포넌트 내부에 **하드코딩**한다.
  (나중에 사람이 직접 수정할 부분이므로 별도 데이터 파일로 분리하지 않는다.)
- `InfoTab.tsx` 같은 별도 컴포넌트로 분리하여 수정이 쉽도록 한다.
- 탭 전환 상태는 `SetupScreen` 내부의 로컬 `useState`로 관리한다.
  (`GameState`에 추가하지 않는다.)

---

## 4. 문제 수 조정 기능

### 기능 설명

현재 고정값인 10문제를 플레이어가 직접 설정할 수 있도록 한다.

### 설정값

- 선택 가능 범위: **5 / 10 / 15 / 20** (5문제 단위)
- 기본값: **10** (기존과 동일)
- `questions.json`의 문제 수가 선택값보다 적으면, 전체 문제를 사용한다.

### UI

`SetupScreen`의 "게임 시작" 탭 내 기존 설정 항목(게임 모드, 난이도, 채점 방식) 아래에
추가한다.

```
문제 수
[ 5문제 ]  [ 10문제 ★ ]  [ 15문제 ]  [ 20문제 ]
```

- 다른 설정 항목과 동일한 버튼 그룹 스타일 사용
- ★ 표시는 기본값을 나타내는 것이 아니라 **현재 선택된 값** 표시를 의미함

### State 변경

#### GameState에 필드 추가

```typescript
interface GameState {
  // ... 기존 필드
  totalQuestions: number;   // 추가: 이번 게임의 총 문제 수 (기본값: 10)
}
```

#### 초기값

```typescript
const initialState: GameState = {
  // ... 기존 초기값
  totalQuestions: 10,
};
```

#### 액션 추가

```typescript
| { type: "SET_TOTAL_QUESTIONS"; payload: number }
```

### 기존 코드에서 `10` 하드코딩 제거

아래 위치에서 숫자 `10`을 `state.totalQuestions`로 교체한다.

- `GameHeader`의 문제 진행 표시: `문제: {currentIndex + 1} / {totalQuestions}`
- `useGameLogic.ts`의 게임 종료 조건:
  ```typescript
  // 변경 전
  if (currentIndex + 1 >= 10) { ... }
  // 변경 후
  if (currentIndex + 1 >= state.totalQuestions) { ... }
  ```
- 문제 무작위 선택 로직:
  ```typescript
  // 변경 전
  const selected = shuffle(questions).slice(0, 10);
  // 변경 후
  const selected = shuffle(questions).slice(0, state.totalQuestions);
  ```
- `ResultScreen`의 총점 표시:
  ```typescript
  // 변경 전
  {totalScore} / 10.00
  // 변경 후
  {totalScore} / {totalQuestions}.00
  ```

### 점수 등급 기준 조정

현재 등급 기준은 10문제 만점 기준으로 절대값으로 설정되어 있다.
문제 수가 바뀌면 만점이 달라지므로 **비율 기준**으로 변경한다.

```typescript
// 변경 전 (절대값)
score >= 9.0  → S
score >= 7.0  → A
...

// 변경 후 (비율)
const ratio = totalScore / totalQuestions;
ratio >= 0.90  → S
ratio >= 0.70  → A
ratio >= 0.50  → B
ratio >= 0.30  → C
그 외          → D
```

---

---

## 5. "틀려도 괜찮아" 탭 — 모바일 가로 넘침 수정

### 문제 상황

모바일에서 "틀려도 괜찮아" 탭을 열면, 랜덤 오답의 토큰 카드 목록이 화면 가로 너비를
초과하여 잘리거나 화면 밖으로 튀어나오는 문제가 발생한다.

### 원인

오답 토큰 카드를 가로로 나열할 때 `flex-nowrap` 또는 고정 너비가 적용되어 있거나,
컨테이너에 `overflow: hidden` 없이 너비 제한만 있을 경우 발생한다.

### 해결 방법

오답 토큰 카드 목록 컨테이너에 아래 두 가지를 동시에 적용한다.

**① flex-wrap 적용**

토큰 카드들이 한 줄에 들어가지 않으면 자동으로 줄바꿈되도록 한다.

```css
/* Tailwind */
flex flex-wrap gap-1
```

**② 컨테이너 너비 제한**

부모 컨테이너가 화면 너비를 초과하지 않도록 한다.

```css
/* Tailwind */
w-full max-w-full overflow-hidden
```

### 적용 위치

"틀려도 괜찮아" 탭 내 오답 표시 컴포넌트에서 토큰 카드를 감싸는 컨테이너 요소.
`OtherWrongAnswers` 컴포넌트 또는 이에 준하는 오답 목록 렌더링 부분.

### 검증 조건

- 브라우저 DevTools에서 iPhone SE(375px) 기준으로 확인
- 토큰이 많은 긴 제목(예: 15~20토큰)의 오답이 표시될 때도 가로 스크롤 없이 줄바꿈되어야 함
- 줄바꿈 후 레이아웃이 다음 오답 항목과 겹치지 않아야 함

---

## 6. "틀려도 괜찮아" 탭 — 새로고침 버튼 추가

### 기능 설명

"틀려도 괜찮아" 탭 상단에 새로고침 버튼을 추가한다.
버튼을 누르면 현재 표시 중인 랜덤 오답을 버리고, 동일한 조건으로 DB에서 새로운 랜덤
오답을 다시 불러온다.

### UI 위치 및 디자인

- 탭 콘텐츠 영역의 **우측 상단**에 배치
- 아이콘: 새로고침(↺) 아이콘
- 레이블: 아이콘만 표시 (텍스트 없음). 접근성을 위해 `aria-label="새로고침"` 추가
- 스타일: 작은 아이콘 버튼 (ghost 스타일)
- 로딩 중에는 버튼을 비활성화하고 아이콘을 회전 애니메이션으로 교체

```
┌─────────────────────────────┐
│  틀려도 괜찮아              ↺ │  ← 새로고침 버튼
│ ─────────────────────────── │
│  [토큰] [토큰] [토큰]        │
│  👍 5                        │
│ ─────────────────────────── │
│  ...                        │
└─────────────────────────────┘
```

### 동작 명세

**클릭 시 처리 순서:**

```
1. 버튼 비활성화 + 로딩 스피너 표시
2. GET /api/wrong-answers 재호출 (기존과 동일한 파라미터)
3. 응답 도착 시 현재 목록을 새 데이터로 교체
4. 버튼 활성화 + 스피너 제거
5. 실패 시: 버튼 활성화 + 기존 목록 유지 + 토스트 메시지 "불러오기에 실패했어요"
```

**"조건에 맞는 오답"의 정의**

새로고침 시에도 기존 조회와 동일한 조건을 사용한다.
- 현재 선택된 난이도 기준
- 좋아요 수 내림차순, 최신순 fallback
- 문제당 최대 5개

단, 매번 다른 오답이 보이도록 **서버에서 랜덤 샘플링**을 적용한다.
`GET /api/wrong-answers` API에 `random=true` 쿼리 파라미터를 추가하면
정렬 기준을 무시하고 조건에 맞는 오답 중 랜덤으로 반환한다.

### API 변경 사항

`GET /api/wrong-answers`에 선택적 파라미터 추가:

| 파라미터 | 타입 | 기본값 | 설명 |
|----------|------|--------|------|
| `random` | boolean | false | true면 랜덤 샘플링, false면 기존 정렬(좋아요순) |

`random=true`일 때 서버 처리:
- 조건에 맞는 전체 오답 중 `ORDER BY RANDOM()` 적용
- 문제당 최대 5개 반환 (기존과 동일)

### 상태 관리

새로고침 로딩 상태는 "틀려도 괜찮아" 탭 컴포넌트의 로컬 `useState`로 관리한다.
(`GameState`에 추가하지 않는다.)

```typescript
const [isRefreshing, setIsRefreshing] = useState(false);
```

---

## 7. 구현 순서

의존성이 없는 항목부터 처리한다. 아래 순서를 따를 것.

```
[1단계] 문제 수 조정
  → GameState에 totalQuestions 추가
  → 하드코딩된 10 전부 교체
  → SetupScreen에 문제 수 선택 UI 추가
  → 점수 등급 기준 비율로 변경
  → 빌드 및 동작 확인

[2단계] 메인화면 복귀 버튼
  → ConfirmDialog 컴포넌트 작성
  → RETURN_TO_SETUP 액션 추가
  → GameHeader에 버튼 추가
  → 다이얼로그 → 상태 초기화 동작 확인

[3단계] 정보 탭
  → InfoTab.tsx 컴포넌트 작성 (placeholder 텍스트 포함)
  → SetupScreen을 탭 구조로 변경 (기존 "틀려도 괜찮아" 탭 구조 유지)
  → 탭 전환 동작 확인

[4단계] "틀려도 괜찮아" 탭 — 모바일 가로 넘침 수정
  → 오답 토큰 컨테이너에 flex-wrap, w-full 적용
  → DevTools iPhone SE(375px)에서 긴 제목 오답 표시 확인

[5단계] "틀려도 괜찮아" 탭 — 새로고침 버튼
  → GET /api/wrong-answers에 random 파라미터 추가 (백엔드)
  → 새로고침 버튼 UI 추가
  → 로딩 중 비활성화 + 스피너 동작 확인
  → 실패 시 토스트 메시지 확인

[6단계] 모바일 스크롤/드래그 충돌 해결
  → TokenPool, InputArea에서 드래그 관련 코드 제거
  → touch-action: pan-y 적용
  → 브라우저 DevTools 모바일 에뮬레이터로 스크롤/탭 동작 검증
```
